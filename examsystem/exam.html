<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam - Exam Site</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="exam-container">
        <div class="exam-sidebar">
            <div class="student-info">
                <h3>Student Information</h3>
                <p><strong>Name:</strong> <span id="student-name"></span></p>
                <p><strong>ID:</strong> <span id="student-id"></span></p>
                <p><strong>Subject:</strong> <span id="exam-subject"></span></p>
            </div>
            
            <div class="recording-status">
                <h3>Recording Status</h3>
                <p id="recording-status">Not Recording</p>
                <p class="recording-note" style="font-size: 12px; color: #666; margin-top: 8px;">Screen is being recorded during the exam</p>
            </div>
            
            <button id="submit-exam-btn" class="btn-primary" style="margin-top: 20px;">Submit Exam</button>
        </div>
        
        <div class="exam-content">
            <div id="loading">Loading questions...</div>
            <div id="questions-container" style="display: none;">
                
                <section class="question-section">
                    <h2>Multiple Choice Questions <span class="points-info">(5 points each)</span></h2>
                    <div id="multiple-choice-questions"></div>
                </section>
                
                <section class="question-section">
                    <h2>Fill in the Blank Questions <span class="points-info">(5 points each)</span></h2>
                    <div id="fill-in-blank-questions"></div>
                </section>
                
                <section class="question-section">
                    <h2>Long Answer Questions <span class="points-info">(10 points each)</span></h2>
                    <div id="long-answer-questions"></div>
                </section>
            </div>
        </div>
    </div>

    <div id="score-modal" class="modal" style="display: none;">
        <div class="modal-content score-modal-content">
            <div class="modal-header">
                <h2>Exam Submitted Successfully!</h2>
            </div>
            <div class="modal-body">
                <div class="score-result">
                    <h3>Your Auto-Graded Score</h3>
                    <div class="score-display">
                        <span id="score-value">0</span> / <span id="max-score-value">0</span>
                    </div>
                    <div class="score-breakdown-modal">
                        <p><strong>Multiple Choice:</strong> <span id="mc-result">0/0</span> correct</p>
                        <p><strong>Fill in Blank:</strong> <span id="fib-result">0/0</span> correct</p>
                        <p><strong>Long Answer:</strong> <span id="la-result">0</span> questions (pending manual review)</p>
                    </div>
                    <p class="score-note">Note: Long answer questions will be reviewed by an administrator. Your final score may change after review.</p>
                </div>
                <button onclick="goToDashboard()" class="btn-primary" style="margin-top: 20px;">Go to Dashboard</button>
            </div>
        </div>
    </div>

    <script src="static/js/main.js"></script>
    <script>
    let screenRecorder;
    let screenChunks = [];
    let screenStream;
    let recordingId;
    let currentSubject = new URLSearchParams(window.location.search).get('subject');

    async function startRecording() {
        try {
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { mediaSource: 'screen' },
                audio: true
            });
            
            screenRecorder = new MediaRecorder(screenStream, {
                mimeType: 'video/webm'
            });
            
            screenRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    screenChunks.push(event.data);
                }
            };
            
            screenRecorder.start();
            
            const response = await fetch('https://1.s.csec.top:10097/api/save-recording', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subject: currentSubject })
            });
            
            const data = await response.json();
            recordingId = data.recording_id;
            
            document.getElementById('recording-status').textContent = 'Recording...';
            document.getElementById('recording-status').style.color = '#ef4444';
            
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Failed to start recording. Please allow screen access.');
        }
    }

    async function stopRecording() {
        return new Promise((resolve) => {
            if (screenRecorder && screenRecorder.state !== 'inactive') {
                screenRecorder.onstop = async () => {
                    const blob = new Blob(screenChunks, { type: 'video/webm' });
                    await uploadRecording(blob, 'screen');
                    resolve();
                };
                screenRecorder.stop();
            } else {
                resolve();
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('recording-status').textContent = 'Recording Stopped';
            document.getElementById('recording-status').style.color = '#22c55e';
        });
    }

    async function uploadRecording(blob, type) {
        if (!recordingId) return;
        
        try {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            
            return new Promise((resolve, reject) => {
                reader.onloadend = async () => {
                    try {
                        const response = await fetch('https://1.s.csec.top:10097/api/upload-recording', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                recording_id: recordingId,
                                type: type,
                                video_data: reader.result
                            })
                        });
                        
                        const data = await response.json();
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
            });
        } catch (error) {
            console.error(`Error uploading ${type} recording:`, error);
        }
    }

    async function loadQuestions() {
        try {
            const response = await fetch(`https://1.s.csec.top:10097/api/questions/${currentSubject}`);
            const questions = await response.json();
            
            const mcContainer = document.getElementById('multiple-choice-questions');
            questions.multiple_choice.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <p class="question-text"><strong>Q${index + 1}.</strong> ${q.question}</p>
                    ${q.options.map((option, i) => `
                        <label class="option">
                            <input type="radio" name="mc_${q._id}" value="${option}">
                            <span>${option}</span>
                        </label>
                    `).join('')}
                `;
                mcContainer.appendChild(questionDiv);
            });
            
            const fibContainer = document.getElementById('fill-in-blank-questions');
            questions.fill_in_blank.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <p class="question-text"><strong>Q${index + 6}.</strong> ${q.question}</p>
                    <input type="text" class="answer-input" data-question-id="${q._id}" data-type="fill_in_blank">
                `;
                fibContainer.appendChild(questionDiv);
            });
            
            const laContainer = document.getElementById('long-answer-questions');
            questions.long_answer.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <p class="question-text"><strong>Q${index + 11}.</strong> ${q.question}</p>
                    <textarea class="answer-textarea" data-question-id="${q._id}" data-type="long_answer" rows="6"></textarea>
                `;
                laContainer.appendChild(questionDiv);
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('questions-container').style.display = 'block';
            
            await startRecording();
            
        } catch (error) {
            console.error('Error loading questions:', error);
            document.getElementById('loading').textContent = 'Error loading questions. Please refresh the page.';
        }
    }

    function showScoreModal(data) {
        document.getElementById('score-value').textContent = data.score;
        document.getElementById('max-score-value').textContent = data.max_score;
        document.getElementById('mc-result').textContent = `${data.mc_correct}/${data.mc_total}`;
        document.getElementById('fib-result').textContent = `${data.fib_correct}/${data.fib_total}`;
        document.getElementById('la-result').textContent = data.la_total;
        
        document.getElementById('score-modal').style.display = 'flex';
    }

    function goToDashboard() {
        window.location.href = 'dashboard.html';
    }

    document.getElementById('submit-exam-btn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to submit the exam?')) {
            return;
        }
        
        const answers = [];
        
        document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
            const questionId = input.name.replace('mc_', '');
            answers.push({
                question_id: questionId,
                answer: input.value,
                type: 'multiple_choice'
            });
        });
        
        document.querySelectorAll('input[data-type="fill_in_blank"]').forEach(input => {
            answers.push({
                question_id: input.dataset.questionId,
                answer: input.value,
                type: 'fill_in_blank'
            });
        });
        
        document.querySelectorAll('textarea[data-type="long_answer"]').forEach(textarea => {
            answers.push({
                question_id: textarea.dataset.questionId,
                answer: textarea.value,
                type: 'long_answer'
            });
        });
        
        document.getElementById('recording-status').textContent = 'Uploading recordings...';
        await stopRecording();
        
        try {
            const response = await fetch('https://1.s.csec.top:10097/api/submit-exam', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: currentSubject,
                    answers: answers,
                    recording_id: recordingId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                window.open("dashboard.html", "_self");
            } else {
                alert('Error submitting exam. Please try again.');
            }
        } catch (error) {
            console.error('Error submitting exam:', error);
            alert('Error submitting exam. Please try again.');
        }
    });

    async function loadStudentInfo() {
        try {
            const response = await fetch('https://1.s.csec.top:10097/api/dashboard', {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('student-name').textContent = data.name;
                document.getElementById('student-id').textContent = data.student_id;
                document.getElementById('exam-subject').textContent = currentSubject;
            }
        } catch (error) {
            console.error('Error loading student info:', error);
        }
    }

    loadStudentInfo();
    loadQuestions();

    window.addEventListener('beforeunload', (e) => {
        e.preventDefault();
        e.returnValue = '';
    });
    </script>
</body>
</html>
